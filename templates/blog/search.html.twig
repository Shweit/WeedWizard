{% extends 'base.html.twig' %}

{% block title %}Suche{% endblock %}

{% block body %}
    <div class="row mt-3 ms-3 me-5">
        <div class="col-3 d-none d-sm-block">
            <div class="position-fixed" style="height: calc(100vh - 140px); border-right: 1px #495057 solid; width: 17%">
                <div class="row d-flex align-items-center mb-3">
                    <div class="col-3">
                        <img src="{{ asset('build/images/logo.webp') }}" alt="Logo" height="50px" class="rounded-circle">
                    </div>
                    <div class="col-9">
                        <h5 class="mt-2">WeedWizard<br> Blog</h5>
                    </div>
                </div>
                <hr>
                <ul class="list-group list-group-flush">
                    <a class="list-group-item list-group-item-action" href="{{ path('app_blog') }}"><i class="fa-solid fa-house me-2"></i> Home</a>
                    <li class="list-group-item list-group-item-action active"><i class="fa-solid fa-magnifying-glass me-2"></i> Search</li>
                </ul>
                <hr>
                <div class="row align-items-end">
                    {% if app.user.profilePicture %}
                        {% set userProfilePicture = '/uploads/profile_pictures/' ~ app.user.profilePicture %}
                    {% else %}
                        {% set userProfilePicture = '/build/images/userAvatar-placeholder.png' %}
                    {% endif %}
                    <div class="col-3 d-flex justify-content-center">
                        <img src="{{ userProfilePicture }}" alt="Logo" height="50px" class="rounded-circle">
                    </div>
                    <div class="col-9">
                        <h6 class="mt-2 mb-0">{{ app.user.firstname }} {{ app.user.lastname }}</h6>
                        <small class="text-muted">@{{ app.user.username }}</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-9">
            {% if query %}
                <div class="row mb-3">
                    <div class="col-1 d-flex align-items-center justify-content-center">
                        <a href="{{ path('weedwizard_blog_search') }}" class="text-decoration-none"><i class="fa-solid fa-arrow-left fa-xl"></i></a>
                    </div>
                    <div class="col-11">
                        <form method="get">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Suchen nach Beiträgen, User, Tags..." name="query" value="{{ query }}">
                                <button class="btn btn-outline-primary" type="submit">Suchen</button>
                            </div>
                        </form>
                    </div>
                </div>
            {% else %}
                <div class="row mb-3">
                    <div class="col-12">
                        <form method="get">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Suchen nach Beiträgen, User, Tags..." name="query">
                                <button class="btn btn-outline-primary" type="submit">Suchen</button>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}

            {% if query %}
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item locator-nav">
                        <button class="nav-link active" id="top-tab" data-bs-toggle="tab" data-bs-target="#top-tab-pane" type="button" role="tab" aria-controls="top-tab-pane" aria-selected="true">Top</button>
                    </li>
                    <li class="nav-item locator-nav">
                        <button class="nav-link" id="latest-tab" data-bs-toggle="tab" data-bs-target="#latest-tab-pane" type="button" role="tab" aria-controls="latest-tab-pane" aria-selected="false">Neuste</button>
                    </li>
                    <li class="nav-item locator-nav">
                        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users-tab-pane" type="button" role="tab" aria-controls="users-tab-pane" aria-selected="false">User</button>
                    </li>
                    <li class="nav-item locator-nav">
                        <button class="nav-link" id="tags-tab" data-bs-toggle="tab" data-bs-target="#tags-tab-pane" type="button" role="tab" aria-controls="tags-tab-pane" aria-selected="false">Tags</button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <div class="tab-pane fade show active" id="top-tab-pane" role="tabpanel" aria-labelledby="top-tab" tabindex="0">
                        <h4>Top Beiträge</h4>
                        {% if posts['top']|length == 0 %}
                            <div class="alert alert-warning" role="alert">
                                <h4 class="alert-heading">Keine Beiträge gefunden!</h4>
                                <p>Sorry, es wurden keine Beiträge gefunden. Bitte versuche es mit einem anderen Suchbegriff.</p>
                                <hr>
                                <p class="mb-0">Vielen Dank für dein Verständnis.</p>
                            </div>
                        {% endif %}
                        {% for post in posts['top'] %}
                            <div class="col-12 blogEntry" data-created-at="{{ post.createdAt|date('Y-m-d\\TH:i:sP') }}" data-like-count="{{ post.likes.count }}" data-comment-count="{{ post.comments.count }}">
                                <div class="card mb-4 no-rounded-corners no-borders">
                                    <div class="card-body">
                                        <h5 class="card-title d-flex align-items-center">
                                            {% if post.user.profilePicture %}
                                                <div style="background: url('{{ '/uploads/profile_pictures/' ~ userProfile.profilePicture }}'); height: 20px; width: 20px; background-repeat: no-repeat; background-size: cover; background-position: center" class="rounded-circle me-2"></div>
                                            {% else %}
                                                <div style="background: url('{{ asset('build/images/userAvatar-placeholder.png') }}'); height: 20px; width: 20px; background-repeat: no-repeat; background-size: cover; background-position: center" class="rounded-circle me-2"></div>
                                            {% endif %}
                                            {{ post.user.username }} <small class="text-muted h6 mb-0">- {{ post.createdAt|format_datetime('long', 'none', locale='de') }}</small>
                                        </h5>
                                        <p class="card-text">{{ post.content }}</p>
                                    </div>
                                    <div class="card-footer">
                                        <div class="row d-flex">
                                            <div class="col-1">
                                                {% if hasUserLikedPost(app.user, post) %}
                                                    <a onclick="window.toggleLikeBlogEntry({{ post.id }}, 'unlike', this)"><i class="fa-solid fa-heart me-2"></i> {{ post.likes.count }}</a>
                                                {% else %}
                                                    <a onclick="window.toggleLikeBlogEntry({{ post.id }}, 'like', this)"><i class="fa-regular fa-heart me-2"></i> {{ post.likes.count }}</a>
                                                {% endif %}
                                            </div>
                                            <div class="col-1">
                                                <a href="{{ path('app_blog_entry', {'id': post.id}) }}" class="text-decoration-none"><i class="fa-solid fa-comment me-2"></i> {{ post.comments.count }}</a>
                                            </div>
                                            <div class="col-1">
                                                <a onclick="window.copyToClipboard(window.location.host + '/blog/' + {{ post.id }}, 'Beitrag wurde in die Zwischenablage kopiert.')"><i class="fa-solid fa-share"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="tab-pane fade" id="latest-tab-pane" role="tabpanel" aria-labelledby="latest-tab" tabindex="0">
                        <h4>Neuste Beiträge</h4>
                        {% if posts['latest']|length == 0 %}
                            <div class="alert alert-warning" role="alert">
                                <h4 class="alert-heading">Keine Beiträge gefunden!</h4>
                                <p>Sorry, es wurden keine Beiträge gefunden. Bitte versuche es mit einem anderen Suchbegriff.</p>
                                <hr>
                                <p class="mb-0">Vielen Dank für dein Verständnis.</p>
                            </div>
                        {% endif %}
                        {% for post in posts['latest'] %}
                            <div class="col-12 blogEntry" data-created-at="{{ post.createdAt|date('Y-m-d\\TH:i:sP') }}" data-like-count="{{ post.likes.count }}" data-comment-count="{{ post.comments.count }}">
                                <div class="card mb-4 no-rounded-corners no-borders">
                                    <div class="card-body">
                                        <h5 class="card-title d-flex align-items-center">
                                            {% if post.user.profilePicture %}
                                                <div style="background: url('{{ '/uploads/profile_pictures/' ~ userProfile.profilePicture }}'); height: 20px; width: 20px; background-repeat: no-repeat; background-size: cover; background-position: center" class="rounded-circle me-2"></div>
                                            {% else %}
                                                <div style="background: url('{{ asset('build/images/userAvatar-placeholder.png') }}'); height: 20px; width: 20px; background-repeat: no-repeat; background-size: cover; background-position: center" class="rounded-circle me-2"></div>
                                            {% endif %}
                                            {{ post.user.username }} <small class="text-muted h6 mb-0">- {{ post.createdAt|format_datetime('long', 'none', locale='de') }}</small>
                                        </h5>
                                        <p class="card-text">{{ post.content }}</p>
                                    </div>
                                    <div class="card-footer">
                                        <div class="row d-flex">
                                            <div class="col-1">
                                                {% if hasUserLikedPost(app.user, post) %}
                                                    <a onclick="window.toggleLikeBlogEntry({{ post.id }}, 'unlike', this)"><i class="fa-solid fa-heart me-2"></i> {{ post.likes.count }}</a>
                                                {% else %}
                                                    <a onclick="window.toggleLikeBlogEntry({{ post.id }}, 'like', this)"><i class="fa-regular fa-heart me-2"></i> {{ post.likes.count }}</a>
                                                {% endif %}
                                            </div>
                                            <div class="col-1">
                                                <a href="{{ path('app_blog_entry', {'id': post.id}) }}" class="text-decoration-none"><i class="fa-solid fa-comment me-2"></i> {{ post.comments.count }}</a>
                                            </div>
                                            <div class="col-1">
                                                <a onclick="window.copyToClipboard(window.location.host + '/blog/' + {{ post.id }}, 'Beitrag wurde in die Zwischenablage kopiert.')"><i class="fa-solid fa-share"></i></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="tab-pane fade" id="users-tab-pane" role="tabpanel" aria-labelledby="users-tab" tabindex="0">
                        <h4>Nutzer</h4>
                        {% if posts['users']|length == 0 %}
                            <div class="alert alert-warning" role="alert">
                                <h4 class="alert-heading">Keine Nutzer gefunden!</h4>
                                <p>Sorry, es wurden keine Nutzer gefunden. Bitte versuche es mit einem anderen Suchbegriff.</p>
                                <hr>
                                <p class="mb-0">Vielen Dank für dein Verständnis.</p>
                            </div>
                        {% endif %}
                        {% for user in posts['users'] %}
                            <div class="row mb-3">
                                <div class="col-1 d-flex align-content-center flex-wrap">
                                    {% if user.profilePicture %}
                                        <div style="background: url('{{ '/uploads/profile_pictures/' ~ user.profilePicture }}'); height: 50px; width: 50px; background-repeat: no-repeat; background-size: cover; background-position: center" class="rounded-circle me-2"></div>
                                    {% else %}
                                        <div style="background: url('{{ asset('/build/images/userAvatar-placeholder.png') }}'); height: 50px; width: 50px; background-repeat: no-repeat; background-size: cover; background-position: center" class="rounded-circle me-2"></div>
                                    {% endif %}
                                </div>
                                <div class="col-9">
                                    <h6 class="mb-0"><a href="{{ path('weedwizard_user_profile', {'username': user.username}) }}">@{{ user.username }}</a> {% if app.user == user %}<span class="badge text-bg-secondary small">Dein Account</span>{% endif %}</h6>
                                    <small class="text-muted">{{ user.email }}</small>
                                    <p>{{ user.bio }}</p>
                                </div>
                                <div class="col-2 d-flex justify-content-end">
                                    {% if app.user != user %}
                                        {% if isUserFollowingUser(app.user, user) %}
                                            <button class="btn btn-outline-primary"><i class="fa-solid fa-user-minus me-2"></i>Entfolgen</button>
                                        {% else %}
                                            <button class="btn btn-primary"><i class="fa-solid fa-user-plus me-2"></i>Folgen</button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <div class="tab-pane fade" id="tags-tab-pane" role="tabpanel" aria-labelledby="tags-tab" tabindex="0">
                        <div class="alert alert-info" role="alert">
                            <h4 class="alert-heading">Work in Progress!</h4>
                            <p>Sorry, this feature is not available yet. Please try again later.</p>
                            <hr>
                            <p class="mb-0">Thank you for your understanding.</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}
